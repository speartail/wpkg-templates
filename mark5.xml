<!-- Mark5 needs to be installed as one of the first things
     so people can get to email quickly after an upgrade
     instead of having to wait for lots of non-critical
     software to install -->

<package
    id='&id;'
    name='MARK Communication System 5'
    revision='&version;-7&revision;'
    reboot='false'
    priority='50'> <!-- see above -->

  <depends package-id='dotnet46' os='windows 7' />

  <variable name='PKG_VERSION'     value='&version;' />
  <variable name='PKG_SOURCE'      value="%SOFTWARE%\Mark5\%PKG_VERSION%\%PROCESSOR_ARCHITECTURE%\Mark5Install.msi" />
  <variable name='PKG_DESTINATION' value="%PROGRAMFILES%\Mark5" />
  <variable name='PKG_TARGET'      value="%ProgramData%\Mark5_%PKG_VERSION%_Mark5Install.msi" />

  <check type="file" condition="versiongreaterorequal" path="%PKG_DESTINATION%\Mark5.exe" value="%PKG_VERSION%" />

  <install include='copy' />
  <install include='remove' />
  <install cmd='%COMSPEC% /c IF NOT EXIST "%PKG_DESTINATION%" MKDIR %PKG_DESTINATION% >nul' timeout='30' />
  <install cmd='msiexec /quiet /norestart /i "%PKG_TARGET%" /lv* "%TEMP%\wpkg-&id;.log"'
           timeout='1200'><exit code='3010' reboot='false' /></install>
  <install cmd='xcopy /Y /I "%SOFTWARE%\Mark5\ConnectionInfo.xml" "%PKG_DESTINATION%" > nul' timeout='30'>
    <exit code='4' />
  </install>

  <upgrade   include='install' />
  <downgrade include='install' />

  <remove cmd='taskkill /f /im mark5.exe'><exit code='any' /></remove>
  <remove cmd='msiexec /quiet /norestart /x "%PKG_TARGET%"' timeout='900'>
    <exit code='1605' />
    <exit code='3010' reboot='false' />
  </remove>

  <commands>
    <command type='copy' cmd='%COMSPEC% /c if not exist %PKG_TARGET% copy %PKG_SOURCE% %PKG_TARGET%'></command>
  </commands>
</package>
